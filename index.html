<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <title>Project Manager</title>
  <style>
    /* åœ¨æ­¤å¤„æ·»åŠ æ‚¨çš„ CSS æ ·å¼ */
    #projects-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;
      margin: 20px;
    }

    .project-icon {
      border: 1px solid black;
      border-radius: 9px;
      display: flex;
      align-items: center;
      margin: 10px;
      cursor: pointer;
    }

    .project-icon.selected {
      border: 1px solid #4caf50;
      background-color: #c6c5c5;
    }

    .project-icon img {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
    }

    .project-actions {
      margin-left: 10px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;

    }

    .project-actions button {
      margin: 5px;
      padding: 5px;
      border-radius: 5px;
      border: none;
      cursor: pointer;
    }

    .project-actions button:hover {
      background-color: #ccc;
    }

    .project-actions button:active {
      background-color: #4caf50;
    }

    .project-actions .project-name {
      font-size: 20px;
      font-weight: bold;
      user-select: none;
      -moz-user-select: none;
      -webkit-user-select: none;
      -ms-user-select: none;
    }

    .progress-container {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      margin: 20px;
    }

    .progress-bar {
      width: 90%;
      height: 5px;
      border-radius: 5px;
      margin: 10px;
      border: 1px solid #ccc;
      background-color: #c6c5c5;
    }

    .progress-bar .progress {
      height: 5px;
      background-color: #4caf50;
      border-radius: 5px;
    }

    .project-summary {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      margin: 20px;
    }

    .project-summary .project-name {
      font-size: 20px;
      font-weight: bold;
    }

    .summary-wrapper {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: left;
    }

    /* liå…ƒç´ å‰æœ‰checkboxå¹¶ä¸”å¯ä»¥å‹¾é€‰ */
    ul {
      list-style-type: none;
      margin: 0;
      padding: 0;
      overflow: hidden;
      background-color: rgb(227, 225, 225);
      /* ulç›¸å¯¹äºproject-summaryå¯¹é½æœ€å·¦è¾¹ï¼Œè€Œä¸æ˜¯å±…ä¸­ */
      width: 80%;
    }

    .project-summary li {
      margin: 10px;
      display: flex;
      align-items: center;
    }

    li::before {
      content: "";
      margin-right: 10px;
    }

    li input[type="checkbox"] {
      margin-right: 10px;
    }

    li input[type="checkbox"]:checked+label {
      text-decoration: line-through;
    }

    /* è®¾ç½®cssæ ·å¼ä½¿summaryçš„ç±»åä¸º"project-actions"çš„divé‡Œçš„å­æ ‡ç­¾ç¾åŒ–æ’åˆ—*/
    .project-summary .project-actions {
      width: 80%;
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: space-around;
    }

    .project-summary .project-actions * {
      margin-right: 4%;
    }

    .project-actions .project-buttons button {
      margin: 5px;
      padding: 5px;
      border-radius: 5px;
      border: none;
      cursor: pointer;
      flex-grow: 0.25;
    }

    .project-actions .project-buttons button:hover {
      background-color: #ccc;
    }

    .project-actions .project-buttons button:active {
      background-color: #4caf50;
    }

    .project-actions .project-name {
      font-size: 20px;
      font-weight: bold;
      flex-grow: 1;
    }

    .project-actions img {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      cursor: pointer;
    }

    /* ä»¥ä¸‹æ˜¯æµ®çª—çš„cssæ ·å¼ */
    .popup2,
    .popup {
      position: absolute;
      height: auto;
      border: 1px solid #999;
      background-color: rgb(255, 255, 255);
      box-shadow: 0 0 5px 0 rgba(0, 0, 0, 0.2);
      visibility: hidden;
      opacity: 0;
      transition: opacity 0.8s;
      border-radius: 5px;
      overflow: hidden;
    }

    .popup2.show,
    .popup.show {
      visibility: visible;
      opacity: 0.95;
    }

    .popup2>div,
    .popup>div {
      padding: 10px;
    }

    .popup2 img,
    .popup img {
      width: 24px;
      height: 24px;
      margin-right: 10px;
      vertical-align: middle;
    }

    .file-item {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }

    .icon {
      margin-right: 10px;
    }

    .folder {
      color: #008000;
    }

    .file {
      color: #0000ff;
    }
  </style>
</head>

<body>
  <!-- åœ¨æ­¤å¤„æ·»åŠ æ‚¨çš„ HTML å†…å®¹ -->

  <!-- æ·»åŠ ä¸€ä¸ªåŒ…å«é¡¹ç›®å›¾æ ‡çš„å®¹å™¨ -->
  <div id="projects-container"></div>

  <!-- æ·»åŠ ä¸€ä¸ªåŒ…å«è¿›åº¦è½´çš„å®¹å™¨ -->
  <div id="progress-container"></div>

  <!-- æ·»åŠ ä¸€ä¸ªæµ®çª— -->
  <div class="popup">
    <div>
      <div id="file-list"></div>
    </div>
  </div>
  <div class="popup2">
    <div>
      <div id="note-list"></div>
    </div>
  </div>

  <script>
    const fs = require('fs');
    const path = require('path');
    const { ipcRenderer } = require('electron');
    const hljs = require('highlight.js/lib/common');
    const showdown = require('showdown');
    // åœ¨æ­¤å¤„ä½¿ç”¨ BrowserWindow ç±»
    const projectsFilePath = path.join(__dirname, 'projects.json');
    // ç¤ºä¾‹é¡¹ç›®æ•°æ®ï¼Œæ‚¨å¯ä»¥æ ¹æ®éœ€è¦ä»å…¶ä»–æ¥æºè·å–æ•°æ®
    const projects = JSON.parse(fs.readFileSync(projectsFilePath, 'utf-8'));
    // åœ¨æ­¤å¤„æ·»åŠ æ‚¨çš„ JavaScript ä»£ç 
    window.shell = require("electron").shell;
    const projectsContainer = document.getElementById("projects-container");
    // ç»‘å®šé”®ç›˜ESCé”®ï¼Œå–æ¶ˆé€‰ä¸­æ‰€æœ‰é¡¹ç›®
    document.addEventListener("keydown", (event) => {
      if (event.key === "Escape") {
        unselectAllProjects();
      }
    });

    // é€‰ä¸­æŸä¸€é¡¹ç›®æ—¶ï¼Œæ‘ä¸‹Ctrl + Eé”®ï¼Œæ‰“å¼€å¯¹åº”çš„é¡¹ç›®New_projectçª—å£
    document.addEventListener("keydown", (event) => {
      if (event.key === "e" && event.ctrlKey) {
        const selectedProject = document.querySelector(".project-icon.selected");
        if (selectedProject) {
          const project = projects.find((project) => {
            return project.name === selectedProject.querySelector(".project-name").innerText;
          });
          console.log(project.name);
          if (project) {
            ipcRenderer.send('openWindow', 'new-project.html', project);
          }
        }
      }
    });
    // é€‰ä¸­ä¸€ä¸ªé¡¹ç›®æ—¶ï¼Œæ‘ä¸‹Ctrl + Dé”®ï¼Œå¼¹å‡ºç¡®è®¤åˆ é™¤å¯¹è¯æ¡†ï¼Œç¡®è®¤åï¼Œåˆ é™¤å¯¹åº”çš„é¡¹ç›®å’Œé…ç½®æ–‡ä»¶ï¼Œå¹¶åˆ·æ–°é¡¹ç›®åˆ—è¡¨
    document.addEventListener("keydown", (event) => {
      if (event.key === "d" && event.ctrlKey) {
        const selectedProject = document.querySelector(".project-icon.selected");
        if (selectedProject) {
          const project = projects.find((project) => {
            return project.name === selectedProject.querySelector(".project-name").innerText;
          });
          console.log("å‡†å¤‡åˆ é™¤ " + project.name);
          if (project) {
            ipcRenderer.send('openWindow', 'delete-project.html', project);
          }
        }
      }
    });
    // å…¨å±€å˜é‡popup
    const popup = document.querySelector(".popup");
    const popup2 = document.querySelector(".popup2");
    // è¯»å–config.jsonæ–‡ä»¶ï¼Œè·å–é…ç½®ä¿¡æ¯
    const configFilePath = path.join(__dirname, 'config.json');
    const config = JSON.parse(fs.readFileSync(configFilePath, 'utf-8'));
    const popupWidth = config.popup.width;
    popup.style.width = popupWidth + "px";
    popup2.style.width = popupWidth + "px";
    // ä½¿ç”¨é¡¹ç›®æ•°æ®åˆ›å»ºé¡¹ç›®å›¾æ ‡
    projects.forEach((project) => {
      const projectIcon = document.createElement("div");
      projectIcon.classList.add("project-icon");
      projectIcon.innerHTML = `
      <div class="project-actions">
      <img src="${project.icon}" alt="${project.name}" />
      <div class="project-name">${project.name}</div>
      </div>
      <div class="project-actions">
        <button class="path-something">ğŸ‘ï¸</button>
        <button class="note-something">ğŸ“</button>
      </div>
    `;

      // æ·»åŠ ç‚¹å‡»äº‹ä»¶å¤„ç†å™¨
      projectIcon.addEventListener("dblclick", () => {
        // é€‰ä¸­é¡¹ç›®
        unselectAllProjects();
        projectIcon.classList.toggle("selected");

        // å¯¼èˆªåˆ°é¡¹ç›®æ–‡ä»¶
        if (projectIcon.classList.contains("selected")) {
          window.shell.openPath(project.path);
          showProgress(project);
        }
      });
      projectIcon.addEventListener("click", () => {
        unselectAllProjects();
        // é€‰ä¸­é¡¹ç›®
        projectIcon.classList.toggle("selected");
        showProgress(project);
      });


      const pathSomethingButton = projectIcon.querySelector(".path-something");
      const noteSomethingButton = projectIcon.querySelector(".note-something");


      // å®šä¹‰pathSomethingButtonçš„hoveräº‹ä»¶
      pathSomethingButton.addEventListener("mouseover", (event) => {
        event.stopPropagation();
        // è®¡ç®—popupæµ®çª—ä½ç½®
        const rect = projectIcon.getBoundingClientRect();
        popup.style.left = rect.left - Math.floor((popupWidth - rect.width) / 2) + "px";
        popup.style.top = rect.bottom + 20 + "px";
        // æ˜¾ç¤ºpopupæµ®çª—
        popup.classList.add("show");
        // è·å–é¡¹ç›®è·¯å¾„
        const projectPath = project.path;
        displayDirectoryContents(projectPath);
      });
      // path-somethingæŒ‰é’®mouseoutäº‹ä»¶
      pathSomethingButton.addEventListener("mouseout", (event) => {
        event.stopPropagation();
        // éšè—popupæµ®çª—
        popup.classList.remove("show");
      });

      noteSomethingButton.addEventListener("click", (event) => {
        event.stopPropagation();
        // åœ¨è¿™é‡Œå®ç°ç¼–è¾‘noteå†…å®¹
        ipcRenderer.send('openWindow', 'note.html', project);
      });
      // å®šä¹‰noteSomethingButtonçš„hoveräº‹ä»¶
      noteSomethingButton.addEventListener("mouseover", (event) => {
        event.stopPropagation();
        // åœ¨è¿™é‡Œå®ç°æ˜¾ç¤ºnoteå†…å®¹
        let note = project.note ? project.note : "æš‚æ— noteå†…å®¹";
        displayNoteContents(note);
        // è®¡ç®—popupæµ®çª—ä½ç½®
        const rect = projectIcon.getBoundingClientRect();
        popup2.style.left = rect.left - Math.floor((popupWidth - rect.width) / 2) + "px";
        popup2.style.top = rect.bottom + 20 + "px";
        // æ˜¾ç¤ºpopupæµ®çª—
        popup2.classList.add("show");

      });
      // note-somethingæŒ‰é’®mouseoutäº‹ä»¶
      noteSomethingButton.addEventListener("mouseout", (event) => {
        event.stopPropagation();
        // éšè—popupæµ®çª—
        popup2.classList.remove("show");
      });
      projectsContainer.appendChild(projectIcon);
    });
    // åœ¨æ­¤å¤„æ·»åŠ å…¶ä»–ä»£ç ...
    // å–æ¶ˆé€‰ä¸­æ‰€æœ‰é¡¹ç›®
    function unselectAllProjects() {
      const projectIcons = document.querySelectorAll(".project-icon");
      projectIcons.forEach((projectIcon) => {
        projectIcon.classList.remove("selected");
      });
    }
    // æ˜¾ç¤ºè¿›åº¦è½´, summaryä¸ºé¡¹ç›®æ‘˜è¦åšæˆTODO listçš„å½¢å¼, progressä¸ºé¡¹ç›®è¿›åº¦
    // TODO listå¯ä»¥ç¼–è¾‘ï¼Œå¯ä»¥æ‰“å‹¾ï¼Œå¯ä»¥æ·»åŠ æ–°çš„TODO
    // é¡¹ç›®è¿›åº¦å¯ä»¥é€šè¿‡æ‰“å‹¾çš„TODOæ•°é‡è®¡ç®—å¾—å‡º
    function showProgress(project) {
      const progressContainer = document.getElementById("progress-container");
      // è·å–summaryæ•°ç»„å¹¶åŠ¨æ€æ·»åŠ åˆ°ulä¸­ï¼Œæ ¼å¼ä¸º<li><input type="checkbox" /><label contenteditable="true">summary[i]</label></li>
      // åœ¨project-nameå³è¾¹æ·»åŠ "æ·»åŠ "æŒ‰é’®å’Œ"åˆ é™¤"æŒ‰é’®ä»¥åŠ"ä¿å­˜"æŒ‰é’®
      progressContainer.innerHTML = `
        <div class="project-summary">
          <div class="project-actions">
            <img src="${project.icon}" alt="${project.name}" />
            <text class="project-name">${project.name}</text>
            <div class="project-buttons"></div>
          </div>
          <div class="summary-wrapper">
            <ul class="summary">
            </ul>
          </div>
        </div>
        <div class="progress-container">
          <div class="progress-bar">
            <div class="progress"></div>
          </div>
          <text class="progress-text"></text>
        </div>
      `;
      const summaryContainer = document.querySelector(".summary");
      let summary = project.summary ? project.summary : [];
      liTempList = [];
      // åŠ¨æ€æ·»åŠ summaryå¦‚{checked: true, content: TODO1, }ï¼Œä»¥åŠå¯¹åº”çš„checkboxçš„å‹¾é€‰çŠ¶æ€, æ ¼å¼ä¸º<li><input type="checkbox" /><label contenteditable="true">summary[i]</label></li>
      summary.forEach((item) => {
        const li = document.createElement("li");
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.checked = item.checked;
        const label = document.createElement("label");
        label.contentEditable = "true";
        label.innerText = item.content;
        li.appendChild(checkbox);
        li.appendChild(label);
        // ç»™liæ·»åŠ ç‚¹å‡»äº‹ä»¶å¤„ç†,labelå¤„äºfocusæ—¶ï¼Œä¿å­˜åˆ°liTempListä¸­,æ–¹ä¾¿åé¢åˆ é™¤
        label.onfocus = () => {
          liTempList.push(li);
        };
        summaryContainer.appendChild(li);
      });

      // æ·»åŠ è¿›åº¦æ¡
      const progress = document.querySelector(".progress");
      const progressText = document.querySelector(".progress-text");
      let toDoList = document.querySelectorAll(".summary li") ? document.querySelectorAll(".summary li") : [];
      let toDoListLength = toDoList.length;
      // è®¡ç®—å·²ç»å®Œæˆçš„TODOæ•°é‡
      let checkedToDoListLength = 0;
      for (let i = 0; i < toDoListLength; i++) {
        if (toDoList[i].querySelector("input").checked) {
          checkedToDoListLength++;
        }
      }
      if (toDoListLength === 0) {
        progressText.innerText = "0%";
        progress.style.width = "0%";
      } else {
        progressText.innerText = `${Math.round((checkedToDoListLength / toDoListLength) * 100)}%`;
        progress.style.width = `${(checkedToDoListLength / toDoListLength) * 100}%`;
      }
      toDoList.forEach((toDo) => {
        const checkbox = toDo.querySelector("input");
        checkbox.addEventListener("click", () => {
          if (checkbox.checked) {
            checkedToDoListLength++;
          } else {
            checkedToDoListLength--;
          }
          progress.style.width = `${(checkedToDoListLength / toDoListLength) * 100}%`;
          progressText.innerText = `${Math.round((checkedToDoListLength / toDoListLength) * 100)}%`;
        });
      });
      // åœ¨project-actionsä¸­æ·»åŠ æ·»åŠ æŒ‰é’®å¯ä»¥æ·»åŠ æ–°çš„TODO
      const projectActions = document.querySelector(".project-summary .project-buttons");
      const addButton = document.createElement("button");
      addButton.innerText = "æ·»åŠ ";
      addButton.classList.add("add-button");
      addButton.addEventListener("click", () => {
        const toDo = document.createElement("li");
        toDo.innerHTML = `
          <input type="checkbox" />
          <label contenteditable="true">New TODO</label>
        `;
        // ç»™æ–°çš„TODOæ·»åŠ ç‚¹å‡»äº‹ä»¶å¤„ç†å™¨
        const newLabel = toDo.querySelector("label");
        newLabel.onfocus = () => {
          liTempList.push(toDo);
        };

        summaryContainer.appendChild(toDo);
        toDoListLength++;
        // æ·»åŠ æ–°çš„TODOåæ›´æ–°è¿›åº¦æ¡
        progress.style.width = `${(checkedToDoListLength / toDoListLength) * 100}%`;
        progressText.innerText = `${Math.round((checkedToDoListLength / toDoListLength) * 100)}%`;
        // æ·»åŠ æ–°çš„TODOåç»™æ–°çš„TODOæ·»åŠ ç‚¹å‡»äº‹ä»¶å¤„ç†å™¨
        const checkbox = toDo.querySelector("input");
        checkbox.addEventListener("click", () => {
          if (checkbox.checked) {
            checkedToDoListLength++;
          } else {
            checkedToDoListLength--;
          }
          progress.style.width = `${(checkedToDoListLength / toDoListLength) * 100}%`;
          progressText.innerText = `${Math.round((checkedToDoListLength / toDoListLength) * 100)}%`;
        });
      });
      projectActions.appendChild(addButton);


      // åœ¨project-actionsä¸­æ·»åŠ åˆ é™¤æŒ‰é’®å¯ä»¥åˆ é™¤TODO
      const deleteButton = document.createElement("button");
      deleteButton.innerText = "åˆ é™¤";
      deleteButton.classList.add("delete-button");
      // åˆ é™¤æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶å¤„ç†å™¨
      deleteButton.addEventListener("click", () => {
        // å…ˆè·å–liTempListçš„æœ€åä¸€ä¸ªå…ƒç´ ï¼Œç„¶ååˆ é™¤è¯¥å…ƒç´ ï¼Œæœ€åæŠŠå…‰æ ‡ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªå…ƒç´ æˆ–ä¸Šä¸€ä¸ªå…ƒç´ 
        const li = liTempList.pop();
        const nextLi = li.nextSibling || li.previousSibling;
        li.parentNode.removeChild(li);
        toDoListLength--;
        if (li.querySelector("input").checked) {
          checkedToDoListLength--;
        }
        if (nextLi) {
          nextLi.focus();
        }
        // åˆ é™¤TODOåæ›´æ–°è¿›åº¦æ¡
        progress.style.width = `${(checkedToDoListLength / toDoListLength) * 100}%`;
        progressText.innerText = `${Math.round((checkedToDoListLength / toDoListLength) * 100)}%`;
      });
      projectActions.appendChild(deleteButton);

      // åœ¨project-actionsä¸­æ·»åŠ ä¿å­˜æŒ‰é’®å¯ä»¥æŠŠæ•°ç»„å½¢å¼çš„summaryä¿å­˜åˆ°é¡¹ç›®é…ç½®æ–‡ä»¶ä¸­
      const saveButton = document.createElement("button");
      saveButton.innerText = "ä¿å­˜";
      saveButton.classList.add("save-button");
      saveButton.addEventListener("click", () => {
        // åœ¨è¿™é‡Œå®ç°ä¿å­˜åŠŸèƒ½
        toDoList = document.querySelectorAll(".summary li");
        // åŒæ—¶ä¿å­˜æ¯ä¸ªtodolistçš„checkboxçŠ¶æ€
        summary = [];
        toDoList.forEach((toDo) => {
          const checkbox = toDo.querySelector("input");
          const label = toDo.querySelector("label");
          summary.push({
            checked: checkbox.checked,
            content: label.innerText
          });
        });
        project.summary = summary;
        console.log(project.summary);
        // æ›´æ–°projectså˜é‡çš„å€¼
        projects.forEach((p) => {
          if (p.name === project.name) {
            p.summary = project.summary;
          }
        });
        fs.writeFileSync(projectsFilePath, JSON.stringify(projects));

      });
      projectActions.appendChild(saveButton);
    }
    // æµ®çª—ç”¨äºé¢„è§ˆæ˜¾ç¤ºå’Œç¼–è¾‘path-somethingçš„å†…å®¹ä»¥åŠé¢„è§ˆå’Œç¼–è¾‘note-somethingçš„å†…å®¹
    const fileList = document.getElementById('file-list');
    // å¤„ç†åœ¨file-listä¸­é¢„è§ˆåŠŸèƒ½çš„å‡½æ•°
    function displayDirectoryContents(directoryPath) {
      fs.readdir(directoryPath, (err, files) => {
        if (err) {
          alert(`æ— æ³•è¯»å–ç›®å½•ï¼š${err.message}`);
          return;
        }

        fileList.innerHTML = '';

        files.forEach((file) => {
          const filePath = path.join(directoryPath, file);

          fs.stat(filePath, (err, stats) => {
            if (err) {
              alert(`æ— æ³•è¯»å–æ–‡ä»¶ä¿¡æ¯ï¼š${err.message}`);
              return;
            }

            const fileItem = document.createElement('div');
            fileItem.classList.add('file-item');

            const icon = document.createElement('span');
            icon.classList.add('icon');

            if (stats.isDirectory()) {
              icon.classList.add('folder');
              icon.innerHTML = '&#128193;';
            } else {
              icon.classList.add('file');
              icon.innerHTML = '&#128196;';
            }

            fileItem.appendChild(icon);

            const fileName = document.createElement('span');
            fileName.textContent = file;
            fileItem.appendChild(fileName);

            fileList.appendChild(fileItem);
          });
        });
      });
    }
    // å¤„ç†åœ¨note-listä¸­é¢„è§ˆåŠŸèƒ½çš„å‡½æ•°
    const noteList = document.getElementById('note-list');
    function displayNoteContents(data) {
      noteList.innerHTML = '';
      const noteItem = document.createElement('div');
      noteItem.classList.add('note-item');
      // è½¬æ¢ä¸ºmarkdownæ ¼å¼
      var converter = new showdown.Converter({
        extensions: [
          {
            type: 'lang',
            regex: /```([a-z]*?)\n([\w\W]*?)\n```/g,
            replace: function (match, lang, code) {
              if (hljs.getLanguage(lang)) {
                return '<pre><code class="' + lang + '">' +
                  hljs.highlight(lang, code).value +
                  '</code></pre>';
              }
              return match;
            }
          }
        ]
      });
      const html = converter.makeHtml(data);
      noteItem.innerHTML = html;
      noteList.appendChild(noteItem);
    }
  </script>
</body>

</html>